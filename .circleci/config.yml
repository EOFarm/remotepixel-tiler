version: 2

jobs:
  test:
    docker:
      - image: remotepixel/amazonlinux-gdal:2.4.0
        environment:
          - PYTHONWARNINGS=ignore
          - GDAL_CACHEMAX=75%
          - VSI_CACHE=TRUE
          - VSI_CACHE_SIZE=536870912
          - CPL_TMPDIR="/tmp"
          - GDAL_HTTP_MERGE_CONSECUTIVE_RANGES=YES
          - GDAL_HTTP_MULTIPLEX=YES
          - GDAL_HTTP_VERSION=2
          - CPL_VSIL_CURL_ALLOWED_EXTENSIONS=".TIF,.ovr,.jp2,.tif"
    working_directory: ~/remotepixel-tiler
    steps:
      - checkout
      - run:
          name: install requirements
          command: pip3 install . --no-binary numpy,rasterio -U
      - run:
          name: install test dependencies
          command: pip install pytest pytest-cov codecov pre-commit --user
      - run:
          name: run pytest
          command:  ~/.local/bin/py.test ~/remotepixel-tiler/tests --cov remotepixel-tiler --cov-report term-missing -s -vv
      - run:
          name: run pre-commit
          command:  ~/.local/bin/pre-commit run --all-files
      - run:
          name: upload coverage report
          command: |
             ~/.local/bin/coverage xml
             ~/.local/bin/codecov
          when: always

  package:
    docker:
      - image: remotepixel/amazonlinux-gdal:2.4.0
        environment:
          - PACKAGE_PATH=package.zip
          - PACKAGE_TMP=/root/package
    working_directory: ~/remotepixel-tiler
    steps:
      - checkout
      - attach_workspace:
          at: ~/remotepixel-tiler
      - run:
          name: install requirements
          command: pip3 install . --no-binary numpy,rasterio -t $PACKAGE_TMP -U
      - run:
          name: create package
          command: bin/package.sh
      - persist_to_workspace:
          root: .
          paths:
            - bin/tests.sh
            - package.zip

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - test:
          filters:
            tags:
              only: /.*/
      - package:
          requires:
            - "test"
          filters:
            tags:
              only: /^[0-9]+.*/
            branches:
              ignore: /.*/
      # - deploy:
      #     requires:
      #       - "package"
      #     filters:
      #       tags:
      #         only: /^[0-9]+.*/
      #       branches:
      #         ignore: /.*/
